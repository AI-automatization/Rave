version: '3.8'

# ─── UMUMIY BACKEND BUILD KONFIGURATSIYASI ────────────────────────────────────
x-backend: &backend
  build:
    context: .
    dockerfile: Dockerfile.dev
  restart: unless-stopped
  networks:
    - cinesync_network

# ─── UMUMIY BACKEND VOLUMES (hot-reload uchun) ────────────────────────────────
x-shared-src:
  - &shared1 ./shared/src:/app/shared/src:ro
  - &shared2 ./tsconfig.base.json:/app/tsconfig.base.json:ro

services:

  # ═══════════════════════════════════════════════════════════════
  # INFRA — MongoDB · Redis · Elasticsearch
  # ═══════════════════════════════════════════════════════════════

  mongo:
    image: mongo:7.0
    container_name: cinesync_mongo
    restart: unless-stopped
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    volumes:
      - mongo_data:/data/db
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - cinesync_network

  redis:
    image: redis:7.2-alpine
    container_name: cinesync_redis
    restart: unless-stopped
    ports:
      - '6380:6379'
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - cinesync_network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: cinesync_elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - 'ES_JAVA_OPTS=-Xms512m -Xmx512m'
    ports:
      - '9200:9200'
      - '9300:9300'
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - cinesync_network

  # ═══════════════════════════════════════════════════════════════
  # BACKEND SERVICES
  # ═══════════════════════════════════════════════════════════════

  auth:
    <<: *backend
    container_name: cinesync_auth
    working_dir: /app/services/auth
    command: npm run dev
    ports:
      - '3001:3001'
    env_file: ./services/auth/.env
    environment:
      MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_auth?authSource=admin"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379"
      USER_SERVICE_URL: "http://user:3002"
    depends_on:
      - mongo
      - redis
    volumes:
      - *shared1
      - *shared2
      - ./services/auth/src:/app/services/auth/src

  user:
    <<: *backend
    container_name: cinesync_user
    working_dir: /app/services/user
    command: npm run dev
    ports:
      - '3002:3002'
    env_file: ./services/user/.env
    environment:
      MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_user?authSource=admin"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379"
    depends_on:
      - mongo
      - redis
    volumes:
      - *shared1
      - *shared2
      - ./services/user/src:/app/services/user/src
      - user_uploads:/app/services/user/uploads

  content:
    <<: *backend
    container_name: cinesync_content
    working_dir: /app/services/content
    command: npm run dev
    ports:
      - '3003:3003'
    env_file: ./services/content/.env
    environment:
      MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_content?authSource=admin"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379"
      ELASTICSEARCH_URL: "http://elasticsearch:9200"
    depends_on:
      - mongo
      - redis
      - elasticsearch
    volumes:
      - *shared1
      - *shared2
      - ./services/content/src:/app/services/content/src
      - content_uploads:/app/services/content/uploads

  watch-party:
    <<: *backend
    container_name: cinesync_watch_party
    working_dir: /app/services/watch-party
    command: npm run dev
    ports:
      - '3004:3004'
    env_file: ./services/watch-party/.env
    environment:
      MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_watch_party?authSource=admin"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379"
    depends_on:
      - mongo
      - redis
    volumes:
      - *shared1
      - *shared2
      - ./services/watch-party/src:/app/services/watch-party/src

  battle:
    <<: *backend
    container_name: cinesync_battle
    working_dir: /app/services/battle
    command: npm run dev
    ports:
      - '3005:3005'
    env_file: ./services/battle/.env
    environment:
      MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_battle?authSource=admin"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379"
    depends_on:
      - mongo
      - redis
    volumes:
      - *shared1
      - *shared2
      - ./services/battle/src:/app/services/battle/src

  notification:
    <<: *backend
    container_name: cinesync_notification
    working_dir: /app/services/notification
    command: npm run dev
    ports:
      - '3007:3007'
    env_file: ./services/notification/.env
    environment:
      MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_notification?authSource=admin"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379"
    depends_on:
      - mongo
      - redis
    volumes:
      - *shared1
      - *shared2
      - ./services/notification/src:/app/services/notification/src

  admin:
    <<: *backend
    container_name: cinesync_admin
    working_dir: /app/services/admin
    command: npm run dev
    ports:
      - '3008:3008'
    env_file: ./services/admin/.env
    environment:
      MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_admin?authSource=admin"
      CONTENT_MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_content?authSource=admin"
      USER_MONGO_URI: "mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/cinesync_user?authSource=admin"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379"
    depends_on:
      - mongo
      - redis
    volumes:
      - *shared1
      - *shared2
      - ./services/admin/src:/app/services/admin/src

  # ═══════════════════════════════════════════════════════════════
  # FRONTEND — Next.js Web
  # network_mode: host → localhost:300x rewrites ishlaydi
  # ═══════════════════════════════════════════════════════════════

  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile.dev
    container_name: cinesync_web
    network_mode: host
    environment:
      NEXT_PUBLIC_APP_URL: "http://localhost:3000"
      NEXT_PUBLIC_API_URL: "http://localhost:3000"
      NEXT_PUBLIC_SOCKET_URL: "http://localhost:3004"
      AUTH_SERVICE_URL: "http://localhost:3001/api/v1/auth"
      NEXTAUTH_URL: "http://localhost:3000"
      NEXTAUTH_SECRET: "cinesync_dev_nextauth_secret_2026"
      NEXT_PUBLIC_GOOGLE_CLIENT_ID: "dev_google_client_id"
    depends_on:
      - auth
      - user
      - content
      - watch-party
      - battle
      - notification

# ═══════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════

volumes:
  mongo_data:
  redis_data:
  es_data:
  user_uploads:
  content_uploads:

# ═══════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════

networks:
  cinesync_network:
    driver: bridge
